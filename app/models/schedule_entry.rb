=begin
     <version canonical="1"><pid>b04p5f1y</pid><duration>9000</duration><parent>
<programme type="episode"><pid>b04p5f20</pid>
<title>Thursday - Petroc Trelawny</title></programme></parent>
<types><type>Original version</type></types>
<contributors/>
<segment_events><segment_event><title/><pid>p02cf5yz</pid>
<short_synopsis/>
<medium_synopsis/>
<long_synopsis/>
<version_offset>8345</version_offset>
<position/><is_chapter>0</is_chapter><has_snippet>0</has_snippet><segment type="music"><pid>p02cf5yx</pid><duration>391</duration><primary_contributor pid="p01d1bn4" musicbrainz_gid="287ae3b9-72af-4a45-94eb-ef51473d635f"><name>Choristers of St. Paul's Cathedral</name></primary_contributor><artist>Choristers of St. Paul's Cathedral</artist><track_title>Festival Te Deum for chorus and organ (Op.32)</track_title><track_number>10</track_number><publisher/><record_label>Hyperion</record_label><release_title>Hear my Prayer: Budd/St Paul's Cathedral Choir/Scott</release_title><record_id>n32z36</record_id><catalogue_number/><contributions><contribution><pid>p01d1bn4</pid><name>Choristers of St. Paul's Cathedral</name><role>Choir</role><musicbrainz_gid>287ae3b9-72af-4a45-94eb-ef51473d635f</musicbrainz_gid></contribution><contribution><pid>p01ljvpr</pid><name>Jeremy Budd</name><role>Singer</role><musicbrainz_gid>c9cd4a4e-0727-4a78-975c-04bc3f731e22</musicbrainz_gid></contribution><contribution><pid>p01m2wcq</pid><name>John Scott</name><role>Director</role><musicbrainz_gid>c99fddad-1c5d-4db0-b3ed-6c0833e3318a</musicbrainz_gid></contribution><contribution><pid>p011zlpf</pid><name>Benjamin Britten</name><role>Composer</role><musicbrainz_gid>49ae5227-605a-47a8-9b8e-cd89bf01a97c</musicbrainz_gid></contribution><contribution><pid>p01p1wjm</pid><name>Andrew Lucas</name><role>Performer</role><musicbrainz_gid>4b1b5cd7-1088-4a2a-b2aa-72380abe164f</musicbrainz_gid></contribution></contributions><title>Festival Te Deum for chorus and organ (Op.32)</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event><segment_event><title/><pid>p02cf65l</pid><short_synopsis/><medium_synopsis/><long_synopsis/><version_offset>8792</version_offset><position/><is_chapter>0</is_chapter><has_snippet>0</has_snippet><segment type="music"><pid>p02cf65k</pid><duration>216</duration><primary_contributor pid="p0124fcl" musicbrainz_gid="28accaf9-3a4b-4052-b9d3-8033d3137d2d"><name>Riccardo Chailly</name></primary_contributor><artist>Riccardo Chailly</artist><track_title>The Iron foundry [Zavod] Op.19</track_title><track_number/><publisher/><record_label/><release_title/><record_id>n32z3b</record_id><catalogue_number/><contributions><contribution><pid>p0124fcl</pid><name>Riccardo Chailly</name><role>Conductor</role><musicbrainz_gid>28accaf9-3a4b-4052-b9d3-8033d3137d2d</musicbrainz_gid></contribution><contribution><pid>p02cf65q</pid><name>Mosolov</name><role>Composer</role><musicbrainz_gid/></contribution><contribution><pid>p02cf65s</pid><name>Concertgebouw Orchestra</name><role>Orchestra</role><musicbrainz_gid/></contribution></contributions><title>The Iron foundry [Zavod] Op.19</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event><segment_event><title/><pid>p02cf34r</pid><short_synopsis/><medium_synopsis/><long_synopsis/><version_offset>5614</version_offset><position/><is_chapter>0</is_chapter><has_snippet>0</has_snippet><segment type="music"><pid>p02cf34q</pid><duration>252</duration><primary_contributor pid="p00zy2zj" musicbrainz_gid="83b74911-aa21-4e31-ad1c-5eb505248f5a"><name>Alexandre Tharaud</name></primary_contributor><artist>Alexandre Tharaud</artist><track_title>Concerto in D major H.18.11 - 3rd movement Rondo all'Ungarese</track_title><track_number/><publisher/><record_label/><release_title/><record_id>n32znw</record_id><catalogue_number/><contributions><contribution><pid>p00zy2zj</pid><name>Alexandre Tharaud</name><role>Performer</role><musicbrainz_gid>83b74911-aa21-4e31-ad1c-5eb505248f5a</musicbrainz_gid></contribution><contribution><pid>p01gv8h8</pid><name>Bernard Labadie</name><role>Director</role><musicbrainz_gid>f0094512-54bc-4c3a-9101-a40769409e05</musicbrainz_gid></contribution><contribution><pid>p012k46m</pid><name>Joseph Haydn</name><role>Composer</role><musicbrainz_gid>c130b0fb-5dce-449d-9f40-1437f889f7fe</musicbrainz_gid></contribution><contribution><pid>p01gv8h1</pid><name>Les Violons du Roy</name><role>Ensemble</role><musicbrainz_gid>a118464e-b220-41ff-959d-08da62fa39b7</musicbrainz_gid></contribution></contributions><title>Concerto in D major H.18.11 - 3rd movement Rondo all'Ungarese</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event><segment_event><title/><pid>p02cf3cm</pid><short_synopsis/><medium_synopsis/><long_synopsis/><version_offset>6017</version_offset><position/><is_chapter>0</is_chapter><has_snippet>0</has_snippet><segment type="music"><pid>p02cf3cl</pid><duration>191</duration><primary_contributor pid="p01dh9zh" musicbrainz_gid="38db5a68-06b0-4716-b895-6559e27dc64e"><name>Anna Tilbrook</name></primary_contributor><artist>Anna Tilbrook</artist><track_title>Ludlow and Teme - The Lent Lily</track_title><track_number/><publisher/><record_label/><release_title/><record_id>n32znj</record_id><catalogue_number/><contributions><contribution><pid>p01dh9zh</pid><name>Anna Tilbrook</name><role>Performer</role><musicbrainz_gid>38db5a68-06b0-4716-b895-6559e27dc64e</musicbrainz_gid></contribution><contribution><pid>p00smw5q</pid><name>Ivor Gurney</name><role>Composer</role><musicbrainz_gid>34969eaa-23e6-4dd9-90b8-bb80bb82abc6</musicbrainz_gid></contribution><contribution><pid>p01dfr4w</pid><name>James Gilchrist</name><role>Singer</role><musicbrainz_gid>b143c5fb-ba44-49a5-bc62-441730b96b9b</musicbrainz_gid></contribution><contribution><pid>p01pxs82</pid><name>Fitzwilliam String Quartet</name><role>Ensemble</role><musicbrainz_gid>b22ec63f-2281-4fdc-a324-3ebe41783d2e</musicbrainz_gid></contribution></contributions><title>Ludlow and Teme - The Lent Lily</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event><segment_event><title/><pid>p02cf3kv</pid><short_synopsis/><medium_synopsis/><long_synopsis/><version_offset>6352</version_offset><position/><is_chapter>0</is_chapter><has_snippet>1</has_snippet><segment type="music"><pid>p02303gj</pid><duration>580</duration><primary_contributor pid="p0161w00" musicbrainz_gid="97e78ecf-0d07-461f-817d-16765bc9da25"><name>Leonard Slatkin</name></primary_contributor><artist>Leonard Slatkin</artist><track_title>Cuban overture</track_title><track_number>6</track_number><publisher/><record_label>Angel</record_label><release_title>Barber/Bernstein/Gershwin/Copland: Great American Showpieces</release_title><record_id>nzbmhd</record_id><catalogue_number/><snippet_url>http://static.bbci.co.uk/snippets/segments/gj/p02303gj_noisrc_georgegershwin_cubanoverture.mp3</snippet_url><contributions><contribution><pid>p0161w00</pid><name>Leonard Slatkin</name><role>Conductor</role><musicbrainz_gid>97e78ecf-0d07-461f-817d-16765bc9da25</musicbrainz_gid></contribution><contribution><pid>p00smw7j</pid><name>George Gershwin</name><role>Composer</role><musicbrainz_gid>65744963-191a-44ef-a3c7-b693a808a158</musicbrainz_gid></contribution><contribution><pid>p0161vzy</pid><name>Saint Louis Symphony Orchestra</name><role>Orchestra</role><musicbrainz_gid>851b24ee-d28f-4535-ab0a-08c95862ba8a</musicbrainz_gid></contribution></contributions><title>Cuban overture</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event><segment_event><title/><pid>p02cf4l5</pid><short_synopsis/><medium_synopsis/><long_synopsis/><version_offset>6973</version_offset><position/><is_chapter>0</is_chapter><has_snippet>0</has_snippet><segment type="music"><pid>p02cf4l3</pid><duration>161</duration><primary_contributor pid="p012dqrw" musicbrainz_gid="e04ef24e-b64e-4ca5-a479-b6bc79042ff5"><name>Karol Szymanowski</name></primary_contributor><artist>Karol Szymanowski</artist><track_title>9 Preludes Op.1 - No 8 Andante ma non troppo</track_title><track_number/><publisher/><record_label/><release_title/><record_id>n32znv</record_id><catalogue_number/><contributions><contribution><pid>p012dqrw</pid><name>Karol Szymanowski</name><role>Composer</role><musicbrainz_gid>e04ef24e-b64e-4ca5-a479-b6bc79042ff5</musicbrainz_gid></contribution><contribution><pid>p02cf4l8</pid><name>Martin Roscoe</name><role>Performer</role><musicbrainz_gid/></contribution></contributions><title>9 Preludes Op.1 - No 8 Andante ma non troppo</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event><segment_event><title/><pid>p02cf4xn</pid><short_synopsis/><medium_synopsis/><long_synopsis/><version_offset>7296</version_offset><position/><is_chapter>0</is_chapter><has_snippet>1</has_snippet><segment type="music"><pid>p01p7l6p</pid><duration>170</duration><primary_contributor pid="p012dht3" musicbrainz_gid="0d74dcc7-5684-4695-830f-a9846aad8ba9"><name>Wynton Marsalis</name></primary_contributor><artist>Wynton Marsalis</artist><track_title>Prince of Denmark's March (Trumpet Voluntary)</track_title><track_number/><publisher/><record_label>Sony</record_label><release_title/><record_id>nzvj4q</record_id><catalogue_number/><snippet_url>http://static.bbci.co.uk/snippets/segments/6p/p01p7l6p_noisrc_clarke_princeofdenmarksmarchtrumpetvoluntary.mp3</snippet_url><contributions><contribution><pid>p012dht3</pid><name>Wynton Marsalis</name><role>Performer</role><musicbrainz_gid>0d74dcc7-5684-4695-830f-a9846aad8ba9</musicbrainz_gid></contribution><contribution><pid>p00zzm73</pid><name>English Chamber Orchestra</name><role>Orchestra</role><musicbrainz_gid>8c936585-f1e5-4729-9402-98f319d265b0</musicbrainz_gid></contribution><contribution><pid>p01cshk8</pid><name>Jeremiah Clarke</name><role>Composer</role><musicbrainz_gid>96ea2d41-77f3-4dd4-aba7-08598d202d5c</musicbrainz_gid></contribution></contributions><title>Prince of Denmark's March (Trumpet Voluntary)</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event><segment_event><title/><pid>p02cf5cb</pid><short_synopsis/><medium_synopsis/><long_synopsis/><version_offset>7509</version_offset><position/><is_chapter>0</is_chapter><has_snippet>0</has_snippet><segment type="music"><pid>p02cf5c9</pid><duration>520</duration><primary_contributor pid="p00zzm97" musicbrainz_gid="afb8d624-52d7-4a72-8d0b-62fff3e29f79"><name>Neville Marriner</name></primary_contributor><artist>Neville Marriner</artist><track_title>Serenade (K.361) in B flat major..., 2nd movement; Menuetto</track_title><track_number>3</track_number><publisher/><record_label>Philips</record_label><release_title>Mozart: Serenades: Academy of St Martin in the fields/Marriner</release_title><record_id>n32z28</record_id><catalogue_number/><contributions><contribution><pid>p00zzm97</pid><name>Neville Marriner</name><role>Conductor</role><musicbrainz_gid>afb8d624-52d7-4a72-8d0b-62fff3e29f79</musicbrainz_gid></contribution><contribution><pid>p00z6v0r</pid><name>Academy Of St. Martin In The Fields</name><role>Ensemble</role><musicbrainz_gid>f0ac992d-edd9-4672-ac23-ba0ca93f6539</musicbrainz_gid></contribution><contribution><pid>p00smw68</pid><name>Wolfgang Amadeus Mozart</name><role>Composer</role><musicbrainz_gid>b972f589-fb0e-474e-b64a-803b0364fa75</musicbrainz_gid></contribution></contributions><title>Serenade (K.361) in B flat major..., 2nd movement; Menuetto</title><short_synopsis/><medium_synopsis/><long_synopsis/></segment></segment_event></segment_events><broadcasts><broadcast is_repeat="0" is_blanked="0"><pid>p02bps75</pid><schedule_date>2014-11-20</schedule_date><start>2014-11-20T06:30:00Z</start><end>2014-11-20T09:00:00Z</end><duration>9000</duration><service id="bbc_radio_three" key="radio3"><title>BBC Radio 3</title></service></broadcast></broadcasts><availabilities><availability><start>2014-11-20T09:00:00Z</start><end>2014-12-20T09:00:00Z</end><media_items><media_item><pid>p02cf961</pid><service id="audio_streaming_aac_low_uk"/><start_of_media_availability>2014-11-20T09:24:40Z</start_of_media_availability></media_item><media_item><pid>p02cf99h</pid><service id="audio_streaming_aac_med_uk"/><start_of_media_availability>2014-11-20T09:26:24Z</start_of_media_availability></media_item><media_item><pid>p02cf9f2</pid><service id="audio_streaming_aac_low_nonuk"/><start_of_media_availability>2014-11-20T09:29:54Z</start_of_media_availability></media_item><media_item><pid>p02cfbyf</pid><service id="audio_streaming_wma_low_nonuk"/><start_of_media_availability>2014-11-20T09:42:00Z</start_of_media_availability></media_item><media_item><pid>p02cfcgf</pid><service id="audio_streaming_wma_med_uk"/><start_of_media_availability>2014-11-20T09:54:08Z</start_of_media_availability>
</media_item></media_items></availability></availabilities></version>
=end
class ScheduleEntry < ActiveRecord::Base

  belongs_to :broadcast
  belongs_to :programme
  belongs_to :version

  attr_accessor :chanel
  attr_accessor :response
  attr_accessor :data

  ROOT_URL = 'http://www.bbc.co.uk/programmes/'

  #
  # Read basic scheduled items
  #
  def ScheduleEntry.read(hash)
    entry = ScheduleEntry.where(pid:hash['pid']).first || ScheduleEntry.new
    ["key", "pid", "service", "title", "synopsis", "availability"].each do |key|
       entry.send("#{key}=",hash[key])
    end
    entry.save
  end
  #
  # Load full programme details for linked version
  #
  def ScheduleEntry.fill_details
    ScheduleEntry.all.each do |entry|
      entry.get
      entry.process
      entry.loaded =true
      entry.save
    end
  end


  def url
    "#{ROOT_URL}#{self.pid}.xml"
  end

  def get
    self.response = HTTPI.get(url)
    self.data = Crack::XML.parse(self.response.body)
  end

  def process
    if self.data['version']
      Version.read(self.data['version'])
    elsif self.data['programme']
      Programme.read(self.data['programme'])
    end
  end


  def availability=(hash)
    self.start_at = hash['start']
    self.end_at = hash['end']
  end

  def read_links(hash)

  end

  def read_broadcast(hash)

  end


end
